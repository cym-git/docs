<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AST 团队分享 | chengyuming</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/docs/imgs/oops.png">
    <link rel="apple-touch-icon" href="/docs/imgs/iOS.jpg">
    <link rel="manifest" href="/docs/manifest.json">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_1385737_yilz38tptbd.css">
    <meta name="description" content="Today, have you studied yet?">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/docs/assets/css/0.styles.0efb0bb9.css" as="style"><link rel="preload" href="/docs/assets/css/0.b4e89f64e000386da6ce.css" as="style"><link rel="preload" href="/docs/assets/js/app.1f0be8d1.js" as="script"><link rel="preload" href="/docs/assets/js/3.8beeabb8.js" as="script"><link rel="preload" href="/docs/assets/js/1.226f09af.js" as="script"><link rel="preload" href="/docs/assets/js/47.ba0f0892.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.926dbf22.js"><link rel="prefetch" href="/docs/assets/js/11.2d0d1a2c.js"><link rel="prefetch" href="/docs/assets/js/12.68f6e8db.js"><link rel="prefetch" href="/docs/assets/js/13.e26de132.js"><link rel="prefetch" href="/docs/assets/js/14.69d92f8f.js"><link rel="prefetch" href="/docs/assets/js/15.e51e49aa.js"><link rel="prefetch" href="/docs/assets/js/16.5f76b04a.js"><link rel="prefetch" href="/docs/assets/js/17.55efe120.js"><link rel="prefetch" href="/docs/assets/js/18.a62d2d0c.js"><link rel="prefetch" href="/docs/assets/js/19.4f5a0a03.js"><link rel="prefetch" href="/docs/assets/js/20.26f84e69.js"><link rel="prefetch" href="/docs/assets/js/21.6d7026e6.js"><link rel="prefetch" href="/docs/assets/js/22.7f024372.js"><link rel="prefetch" href="/docs/assets/js/23.6648f3b4.js"><link rel="prefetch" href="/docs/assets/js/24.a4cc854f.js"><link rel="prefetch" href="/docs/assets/js/25.887ec44b.js"><link rel="prefetch" href="/docs/assets/js/26.4ce141b0.js"><link rel="prefetch" href="/docs/assets/js/27.cee1c280.js"><link rel="prefetch" href="/docs/assets/js/28.c09cee79.js"><link rel="prefetch" href="/docs/assets/js/29.d0f0aefe.js"><link rel="prefetch" href="/docs/assets/js/30.9b883ca1.js"><link rel="prefetch" href="/docs/assets/js/31.8bece2b0.js"><link rel="prefetch" href="/docs/assets/js/32.81b1226e.js"><link rel="prefetch" href="/docs/assets/js/33.c8cecac9.js"><link rel="prefetch" href="/docs/assets/js/34.2064a42e.js"><link rel="prefetch" href="/docs/assets/js/35.caa4a73c.js"><link rel="prefetch" href="/docs/assets/js/36.bba3a665.js"><link rel="prefetch" href="/docs/assets/js/37.33998fce.js"><link rel="prefetch" href="/docs/assets/js/38.ca330eee.js"><link rel="prefetch" href="/docs/assets/js/39.93191f86.js"><link rel="prefetch" href="/docs/assets/js/4.99ec264b.js"><link rel="prefetch" href="/docs/assets/js/40.741d7bc0.js"><link rel="prefetch" href="/docs/assets/js/41.cb2b8201.js"><link rel="prefetch" href="/docs/assets/js/42.e6497d0b.js"><link rel="prefetch" href="/docs/assets/js/43.317651fb.js"><link rel="prefetch" href="/docs/assets/js/44.2539d281.js"><link rel="prefetch" href="/docs/assets/js/45.b2b7ea21.js"><link rel="prefetch" href="/docs/assets/js/46.45c1f8f0.js"><link rel="prefetch" href="/docs/assets/js/48.51a253cc.js"><link rel="prefetch" href="/docs/assets/js/49.565e624e.js"><link rel="prefetch" href="/docs/assets/js/5.397a8e38.js"><link rel="prefetch" href="/docs/assets/js/50.d4f1e1ae.js"><link rel="prefetch" href="/docs/assets/js/51.17d58a6d.js"><link rel="prefetch" href="/docs/assets/js/52.752f387f.js"><link rel="prefetch" href="/docs/assets/js/6.0d176e97.js"><link rel="prefetch" href="/docs/assets/js/7.c69ae316.js"><link rel="prefetch" href="/docs/assets/js/8.6d153bec.js"><link rel="prefetch" href="/docs/assets/js/9.aa7ccfa5.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.0efb0bb9.css"><link rel="stylesheet" href="/docs/assets/css/0.b4e89f64e000386da6ce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-395662f4><div data-v-395662f4><div class="password-shadow password-wrapper-out" style="display:none;" data-v-47d04a8e data-v-395662f4 data-v-395662f4><h3 class="title" style="display:none;" data-v-47d04a8e data-v-47d04a8e>chengyuming</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-47d04a8e data-v-47d04a8e><input type="password" value="" data-v-47d04a8e> <span style="width:300px;" data-v-47d04a8e>此文章需要密码访问！</span> <button data-v-47d04a8e>OK</button></label> <div class="footer footer" style="display:none;" data-v-47d04a8e data-v-47d04a8e><p><span class="left">MIT Licensed | Copyright © 2019 - present</span> <span class="record"><b>备案号：</b> <a href="http://beian.miit.gov.cn" class="record-link">京ICP备19052475号</a></span></p></div></div> <div class="hide" data-v-395662f4><header class="navbar" data-v-395662f4><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><img src="/docs/imgs/head.png" alt="chengyuming" class="logo"> <span class="site-name">chengyuming</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><a href="/docs/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/docs/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      基础
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/views/basis/css.html" class="nav-link"><i class="iconfont undefined"></i>
  css
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/javascript.html" class="nav-link"><i class="iconfont undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/inherit.html" class="nav-link"><i class="iconfont undefined"></i>
  继承
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/api.html" class="nav-link"><i class="iconfont undefined"></i>
  常用 Api 实现
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/array.html" class="nav-link"><i class="iconfont undefined"></i>
  数组 Api 实现
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/promise.html" class="nav-link"><i class="iconfont undefined"></i>
  实现 Promise
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/cache.html" class="nav-link"><i class="iconfont undefined"></i>
  浏览器缓存
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/command.html" class="nav-link"><i class="iconfont undefined"></i>
  命令行参数
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/issue.html" class="nav-link"><i class="iconfont undefined"></i>
  工作小技巧
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/interview.html" class="nav-link"><i class="iconfont undefined"></i>
  面试题收录
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont iconqianduan"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/views/webpack/webpack-1.html" class="nav-link"><i class="iconfont undefined"></i>
  webpack介绍
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/webpack/webpack-2.html" class="nav-link"><i class="iconfont undefined"></i>
  webpack实战
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/webpack/webpack-3.html" class="nav-link"><i class="iconfont undefined"></i>
  webpack拓展
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/webpack/getport.html" class="nav-link"><i class="iconfont undefined"></i>
  如何优雅的解决端口被占用
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/algorithms/tree.html" class="nav-link"><i class="iconfont undefined"></i>
  树在工作面试中的应用
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/webpack/vue.html" class="nav-link"><i class="iconfont undefined"></i>
  从0搭建vue
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/webpack/AST.html" aria-current="page" class="nav-link router-link-exact-active router-link-active"><i class="iconfont undefined"></i>
  AST团队分享
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/FE/lint.html" class="nav-link"><i class="iconfont undefined"></i>
  eslint 工作流
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/vue.html" class="nav-link"><i class="iconfont undefined"></i>
  Vue 源码分析
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/tools/npm/cli.html" class="nav-link"><i class="iconfont undefined"></i>
  cli 开发
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/plugins/vscode.html" class="nav-link"><i class="iconfont undefined"></i>
  vscode 开发记录
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/plugins/chrome.html" class="nav-link"><i class="iconfont undefined"></i>
  Chrome 开发记录
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/FE/visualization/mapbox.html" class="nav-link"><i class="iconfont undefined"></i>
  mapbox
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/FE/process/websize-render.html" class="nav-link"><i class="iconfont undefined"></i>
  网站渲染流程
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-beian"></i>
      服务端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/views/server-side/node/fs.html" class="nav-link"><i class="iconfont undefined"></i>
  fs文件系统
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/server-side/service-conf.html" class="nav-link"><i class="iconfont undefined"></i>
  服务器的配置
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/server-side/vmware.html" class="nav-link"><i class="iconfont undefined"></i>
  虚拟机
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/server-side/linux.html" class="nav-link"><i class="iconfont undefined"></i>
  Linux命令
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/server-side/http.html" class="nav-link"><i class="iconfont undefined"></i>
  http笔记
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/server-side/https.html" class="nav-link"><i class="iconfont undefined"></i>
  https笔记
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/tools/nginx/requisite.html" class="nav-link"><i class="iconfont undefined"></i>
  负载均衡
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/jwt.html" class="nav-link"><i class="iconfont undefined"></i>
  HTTP认证方式
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/server-side/node/crypto.html" class="nav-link"><i class="iconfont undefined"></i>
  加密解密
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-npm"></i>
      工具
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/views/tools/npm/init.html" class="nav-link"><i class="iconfont undefined"></i>
  npm
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/tools/mysql.html" class="nav-link"><i class="iconfont undefined"></i>
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/tools/redis.html" class="nav-link"><i class="iconfont undefined"></i>
  redis
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/tools/nginx/index.html" class="nav-link"><i class="iconfont undefined"></i>
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/tools/git/git-submodules.html" class="nav-link"><i class="iconfont undefined"></i>
  git子模块
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/fecym" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont icongithub"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-395662f4></div> <aside class="sidebar" data-v-395662f4><div class="personal-info-wrapper" data-v-2ef94353><!----> <h3 class="name" data-v-2ef94353>
    fecym
  </h3> <div class="num" data-v-2ef94353></div> <hr data-v-2ef94353></div> <nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><a href="/docs/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/docs/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      基础
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/views/basis/css.html" class="nav-link"><i class="iconfont undefined"></i>
  css
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/javascript.html" class="nav-link"><i class="iconfont undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/inherit.html" class="nav-link"><i class="iconfont undefined"></i>
  继承
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/api.html" class="nav-link"><i class="iconfont undefined"></i>
  常用 Api 实现
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/array.html" class="nav-link"><i class="iconfont undefined"></i>
  数组 Api 实现
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/promise.html" class="nav-link"><i class="iconfont undefined"></i>
  实现 Promise
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/cache.html" class="nav-link"><i class="iconfont undefined"></i>
  浏览器缓存
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/command.html" class="nav-link"><i class="iconfont undefined"></i>
  命令行参数
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/issue.html" class="nav-link"><i class="iconfont undefined"></i>
  工作小技巧
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/interview.html" class="nav-link"><i class="iconfont undefined"></i>
  面试题收录
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont iconqianduan"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/views/webpack/webpack-1.html" class="nav-link"><i class="iconfont undefined"></i>
  webpack介绍
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/webpack/webpack-2.html" class="nav-link"><i class="iconfont undefined"></i>
  webpack实战
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/webpack/webpack-3.html" class="nav-link"><i class="iconfont undefined"></i>
  webpack拓展
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/webpack/getport.html" class="nav-link"><i class="iconfont undefined"></i>
  如何优雅的解决端口被占用
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/algorithms/tree.html" class="nav-link"><i class="iconfont undefined"></i>
  树在工作面试中的应用
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/webpack/vue.html" class="nav-link"><i class="iconfont undefined"></i>
  从0搭建vue
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/webpack/AST.html" aria-current="page" class="nav-link router-link-exact-active router-link-active"><i class="iconfont undefined"></i>
  AST团队分享
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/FE/lint.html" class="nav-link"><i class="iconfont undefined"></i>
  eslint 工作流
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/vue.html" class="nav-link"><i class="iconfont undefined"></i>
  Vue 源码分析
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/tools/npm/cli.html" class="nav-link"><i class="iconfont undefined"></i>
  cli 开发
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/plugins/vscode.html" class="nav-link"><i class="iconfont undefined"></i>
  vscode 开发记录
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/plugins/chrome.html" class="nav-link"><i class="iconfont undefined"></i>
  Chrome 开发记录
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/FE/visualization/mapbox.html" class="nav-link"><i class="iconfont undefined"></i>
  mapbox
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/FE/process/websize-render.html" class="nav-link"><i class="iconfont undefined"></i>
  网站渲染流程
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-beian"></i>
      服务端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/views/server-side/node/fs.html" class="nav-link"><i class="iconfont undefined"></i>
  fs文件系统
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/server-side/service-conf.html" class="nav-link"><i class="iconfont undefined"></i>
  服务器的配置
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/server-side/vmware.html" class="nav-link"><i class="iconfont undefined"></i>
  虚拟机
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/server-side/linux.html" class="nav-link"><i class="iconfont undefined"></i>
  Linux命令
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/server-side/http.html" class="nav-link"><i class="iconfont undefined"></i>
  http笔记
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/server-side/https.html" class="nav-link"><i class="iconfont undefined"></i>
  https笔记
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/tools/nginx/requisite.html" class="nav-link"><i class="iconfont undefined"></i>
  负载均衡
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/basis/jwt.html" class="nav-link"><i class="iconfont undefined"></i>
  HTTP认证方式
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/server-side/node/crypto.html" class="nav-link"><i class="iconfont undefined"></i>
  加密解密
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-npm"></i>
      工具
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/views/tools/npm/init.html" class="nav-link"><i class="iconfont undefined"></i>
  npm
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/tools/mysql.html" class="nav-link"><i class="iconfont undefined"></i>
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/tools/redis.html" class="nav-link"><i class="iconfont undefined"></i>
  redis
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/tools/nginx/index.html" class="nav-link"><i class="iconfont undefined"></i>
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/docs/views/tools/git/git-submodules.html" class="nav-link"><i class="iconfont undefined"></i>
  git子模块
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/fecym" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont icongithub"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>AST 团队分享</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/views/webpack/AST.html#什么是-ast" class="sidebar-link">什么是 AST</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/views/webpack/AST.html#词法分析和语法分析" class="sidebar-link">词法分析和语法分析</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/views/webpack/AST.html#ast-能做什么" class="sidebar-link">AST 能做什么</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/views/webpack/AST.html#ast-解析流程" class="sidebar-link">AST 解析流程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/views/webpack/AST.html#修改函数名字" class="sidebar-link">修改函数名字</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/views/webpack/AST.html#babel-工作原理" class="sidebar-link">babel 工作原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#插件和预设的区别" class="sidebar-link">插件和预设的区别</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#babel-插件的使用" class="sidebar-link">babel 插件的使用</a></li></ul></li><li><a href="/docs/views/webpack/AST.html#编写自己的插件" class="sidebar-link">编写自己的插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#分析-ast-结构" class="sidebar-link">分析 AST 结构</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#访问者模式" class="sidebar-link">访问者模式</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#修改-ast-结构" class="sidebar-link">修改 AST 结构</a></li></ul></li><li><a href="/docs/views/webpack/AST.html#按需引入" class="sidebar-link">按需引入</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#分析语法树" class="sidebar-link">分析语法树</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#分析类型" class="sidebar-link">分析类型</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#上代码" class="sidebar-link">上代码</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#特殊情况" class="sidebar-link">特殊情况</a></li></ul></li><li><a href="/docs/views/webpack/AST.html#babylon" class="sidebar-link">babylon</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#babylon-与-babel-的关系" class="sidebar-link">babylon 与 babel 的关系</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#使用-babylon" class="sidebar-link">使用 babylon</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#分析语法树-2" class="sidebar-link">分析语法树</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#分析类型-2" class="sidebar-link">分析类型</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#上代码-2" class="sidebar-link">上代码</a></li></ul></li><li><a href="/docs/views/webpack/AST.html#优雅处理-async-await" class="sidebar-link">优雅处理 async await</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#分析语法树-3" class="sidebar-link">分析语法树</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#分析类型-3" class="sidebar-link">分析类型</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#代码" class="sidebar-link">代码</a></li><li class="sidebar-sub-header"><a href="/docs/views/webpack/AST.html#其他情况" class="sidebar-link">其他情况</a></li></ul></li><li><a href="/docs/views/webpack/AST.html#具体语法书" class="sidebar-link">具体语法书</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/views/webpack/AST.html#补充" class="sidebar-link">补充</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/views/webpack/AST.html#代码地址" class="sidebar-link">代码地址</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/views/webpack/AST.html#相关链接" class="sidebar-link">相关链接</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-47d04a8e data-v-395662f4><h3 class="title" style="display:none;" data-v-47d04a8e data-v-47d04a8e>AST 团队分享</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-47d04a8e data-v-47d04a8e><input type="password" value="" data-v-47d04a8e> <span style="width:300px;" data-v-47d04a8e>此文章需要密码访问！</span> <button data-v-47d04a8e>OK</button></label> <div class="footer footer" style="display:none;" data-v-47d04a8e data-v-47d04a8e><p><span class="left">MIT Licensed | Copyright © 2019 - present</span> <span class="record"><b>备案号：</b> <a href="http://beian.miit.gov.cn" class="record-link">京ICP备19052475号</a></span></p></div></div> <div data-v-395662f4><main class="page"><!----> <div class="page-title" style="display:none;"><h1>AST 团队分享</h1> <hr> <div data-v-7b2e794a><i class="iconfont reco-account" data-v-7b2e794a><span data-v-7b2e794a>fecym</span></i> <i class="iconfont reco-date" data-v-7b2e794a><span data-v-7b2e794a>2020-06-05</span></i> <i class="iconfont reco-eye" data-v-7b2e794a><span id="/docs/views/webpack/AST.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-7b2e794a><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="iconfont reco-tag tags" data-v-7b2e794a><span class="tag-item" data-v-7b2e794a>
      ast
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><h2 id="什么是-ast"><a href="#什么是-ast" class="header-anchor">#</a> 什么是 AST</h2> <p>抽象语法树（<code>Abstract Syntax Tree</code>）简称 <code>AST</code>，是源代码的抽象语法结构的树状表现形式。<code>webpack</code>、<code>eslint</code> 等很多工具库的核心都是通过抽象语法书这个概念来实现对代码的检查、分析等操作。今天我为大家分享一下 JavaScript 这类解释型语言的抽象语法树的概念</p> <p>我们常用的浏览器就是通过将 js 代码转化为抽象语法树来进行下一步的分析等其他操作。所以将 js 转化为抽象语法树更利于程序的分析。</p> <p align="left" class="p-images"><img src="/docs/imgs/ast.jpg" width="" style="border-radius:8px;"></p> <p>如上图中变量声明语句，转换为 AST 之后就是右图中显示的样式</p> <p>左图中对应的：</p> <ul><li><code>var</code> 是一个关键字</li> <li><code>AST</code> 是一个定义者</li> <li><code>=</code> 是 Equal 等号的叫法有很多形式，在后面我们还会看到</li> <li><code>is tree</code> 是一个字符串</li> <li><code>;</code> 就是 Semicolon</li></ul> <p>首先一段代码转换成的抽象语法树是一个对象，该对象会有一个顶级的 type 属性 <code>Program</code>；第二个属性是 <code>body</code> 是一个数组。</p> <p><code>body</code> 数组中存放的每一项都是一个对象，里面包含了所有的对于该语句的描述信息</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>type:         描述该语句的类型  --<span class="token operator">&gt;</span> 变量声明的语句
kind:         变量声明的关键字  --<span class="token operator">&gt;</span> var
declaration:  声明内容的数组，里面每一项也是一个对象
            type: 描述该语句的类型
            id:   描述变量名称的对象
                type: 定义
                name: 变量的名字
            init: 初始化变量值的对象
                type:   类型
                value:  值 <span class="token string">&quot;is tree&quot;</span> 不带引号
                row:    <span class="token string">&quot;<span class="token entity" title="\&quot;">\&quot;</span>is tree&quot;</span><span class="token punctuation">\</span>&quot; 带引号
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="词法分析和语法分析"><a href="#词法分析和语法分析" class="header-anchor">#</a> 词法分析和语法分析</h2> <p><code>JavaScript</code> 是解释型语言，一般通过 词法分析 -&gt; 语法分析 -&gt; 语法树，就可以开始解释执行了</p> <p>词法分析：也叫<code>扫描</code>，是将字符流转换为记号流(<code>tokens</code>)，它会读取我们的代码然后按照一定的规则合成一个个的标识</p> <p>比如说：<code>var a = 2</code> ，这段代码通常会被分解成 <code>var、a、=、2</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Keyword'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'var'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Identifier'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'a'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Punctuator'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'='</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'Numeric'</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'2'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>当词法分析源代码的时候，它会一个一个字符的读取代码，所以很形象地称之为扫描 - <code>scans</code>。当它遇到空格、操作符，或者特殊符号的时候，它会认为一个话已经完成了。</p> <p>语法分析：也称<code>解析器</code>，将词法分析出来的数组转换成树的形式，同时验证语法。语法如果有错的话，抛出语法错误。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VariableDeclarator&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>语法分析成 AST ，我们可以在这里在线看到效果 <a href="https://esprima.org/demo/parse.html" target="_blank" rel="noopener noreferrer">http://esprima.org<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="ast-能做什么"><a href="#ast-能做什么" class="header-anchor">#</a> AST 能做什么</h2> <ul><li>语法检查、代码风格检查、格式化代码、语法高亮、错误提示、自动补全等</li> <li>代码混淆压缩</li> <li>优化变更代码，改变代码结构等</li></ul> <p>比如说，有个函数 <code>function a() {}</code> 我想把它变成 <code>function b() {}</code></p> <p>比如说，在 <code>webpack</code> 中代码编译完成后 <code>require('a') --&gt; __webapck__require__(&quot;*/**/a.js&quot;)</code></p> <p>下面来介绍一套工具，可以把代码转成语法树然后改变节点以及重新生成代码</p> <h2 id="ast-解析流程"><a href="#ast-解析流程" class="header-anchor">#</a> AST 解析流程</h2> <p>准备工具：</p> <ul><li>esprima：code =&gt; ast 代码转 ast</li> <li>estraverse: traverse ast 转换树</li> <li>escodegen: ast =&gt; code</li></ul> <p>在推荐一个常用的 AST 在线转换网站：<a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">https://astexplorer.net/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>比如说一段代码 <code>function getUser() {}</code>，我们把函数名字更改为 <code>hello</code>，看代码流程</p> <p>看以下代码，简单说明 <code>AST</code> 遍历流程</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> esprima <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'esprima'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> estraverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'estraverse'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function getUser() {}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token comment">// 生成 AST</span>
<span class="token keyword">const</span> ast <span class="token operator">=</span> esprima<span class="token punctuation">.</span><span class="token function">parseScript</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 转换 AST，只会遍历 type 属性</span>
<span class="token comment">// traverse 方法中有进入和离开两个钩子函数</span>
estraverse<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'enter -&gt; node.type'</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'leave -&gt; node.type'</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>输出结果如下：</p> <p align="left" class="p-images"><img src="/docs/imgs/ast-flow-code.jpg" width="" style="border-radius:8px;"></p> <p>由此可以得到 AST 遍历的流程是深度优先，遍历过程如下：</p> <p align="left" class="p-images"><img src="/docs/imgs/ast-flow.jpg" width="" style="border-radius:8px;"></p> <h2 id="修改函数名字"><a href="#修改函数名字" class="header-anchor">#</a> 修改函数名字</h2> <p>此时我们发现函数的名字在 <code>type</code> 为 <code>Identifier</code> 的时候就是该函数的名字，我们就可以直接修改它便可实现一个更改函数名字的 <code>AST</code> 工具</p> <p align="left" class="p-images"><img src="/docs/imgs/ast-flow-fn-name.jpg" width="" style="border-radius:8px;"></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 转换树</span>
estraverse<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 进入离开修改都是可以的</span>
  <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'enter -&gt; node.type'</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'Identifier'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'leave -&gt; node.type'</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 生成新的代码</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> escodegen<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// function hello() {}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="babel-工作原理"><a href="#babel-工作原理" class="header-anchor">#</a> babel 工作原理</h2> <p>提到 AST 我们肯定会想到 babel，自从 Es6 开始大规模使用以来，babel 就出现了，它主要解决了就是一些浏览器不兼容 Es6 新特性的问题，其实就把 Es6 代码转换为 Es5 的代码，兼容所有浏览器，babel 转换代码其实就是用了 AST，babel 与 AST 就有着很一种特别的关系。</p> <p>那么我们就在 babel 的中来使用 AST，看看 babel 是如何编译代码的（不讲源码啊）</p> <p>需要用到两个工具包 <code>@babel/core</code>、<code>@babel/preset-env</code></p> <p>当我们配置 babel 的时候，不管是在 <code>.babelrc</code> 或者 <code>babel.config.js</code> 文件里面配置的都有 <code>presets</code> 和 <code>plugins</code> 两个配置项（还有其他配置项，这里不做介绍）</p> <h3 id="插件和预设的区别"><a href="#插件和预设的区别" class="header-anchor">#</a> 插件和预设的区别</h3> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// .babelrc</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当我们配置了 <code>presets</code> 中有 <code>@babel/preset-env</code>，那么 <code>@babel/core</code> 就会去找 <code>preset-env</code> 预设的插件包，它是一套</p> <p>babel 核心包并不会去转换代码，核心包只提供一些核心 API，真正的代码转换工作由插件或者预设来完成，比如要转换箭头函数，会用到这个 plugin，<code>@babel/plugin-transform-arrow-functions</code>，当需要转换的要求增加时，我们不可能去一一配置相应的 plugin，这个时候就可以用到预设了，也就是 presets。presets 是 plugins 的集合，一个 presets 内部包含了很多 plugin。</p> <h3 id="babel-插件的使用"><a href="#babel-插件的使用" class="header-anchor">#</a> babel 插件的使用</h3> <p>现在我们有一个箭头函数，要想把它转成普通函数，我们就可以直接这么写：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">const fn = (a, b) =&gt; a + b</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token comment">// babel 有 transform 方法会帮我们自动遍历，使用相应的预设或者插件转换相应的代码</span>
<span class="token keyword">const</span> r <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打印结果如下</span>
<span class="token comment">// &quot;use strict&quot;;</span>
<span class="token comment">// var fn = function fn() { return a + b; };</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>此时我们可以看到最终代码会被转成普通函数，但是我们只需要箭头函数转通用函数的功能，不需要用这么大一套包，只需要一个箭头函数转普通函数的包，我们其实是可以在 <code>node_modules</code> 下面找到有个叫做 <code>plugin-transform-arrow-functions</code> 的插件，这个插件是专门用来处理 箭头函数的，我们就可以这么写：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> r <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/plugin-transform-arrow-functions'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打印结果如下</span>
<span class="token comment">// const fn = function () { return a + b; };</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们可以从打印结果发现此时并没有转换我们变量的声明方式还是 const 声明，只是转换了箭头函数</p> <h2 id="编写自己的插件"><a href="#编写自己的插件" class="header-anchor">#</a> 编写自己的插件</h2> <blockquote><p>此时，我们就可以自己来写一些插件，来实现代码的转换，中间处理代码的过程就是使用前面提到的 AST 的处理逻辑</p></blockquote> <p>现在我们来个实战把 <code>const fn = (a, b) =&gt; a + b</code> 转换为 <code>const fn = function(a, b) { return a + b }</code></p> <h3 id="分析-ast-结构"><a href="#分析-ast-结构" class="header-anchor">#</a> 分析 AST 结构</h3> <p>首先我们在在线分析 AST 的网站上分析 <code>const fn = (a, b) =&gt; a + b</code> 和 <code>const fn = function(a, b) { return a + b }</code>看两者语法树的区别</p> <p align="left" class="p-images"><img src="/docs/imgs/ast-arrow-to-fn.jpg" width="" style="border-radius:8px;"></p> <p>根据我们分析可得：</p> <ol><li>变成普通函数之后他就不叫箭头函数了 <code>ArrowFunctionExpression</code>，而是函数表达式了 <code>FunctionExpression</code></li> <li>所以首先我们要把 <code>箭头函数表达式(ArrowFunctionExpression)</code> 转换为 <code>函数表达式(FunctionExpression)</code></li> <li>要把 <code>二进制表达式(BinaryExpression)</code> 包裹在 <code>返回语句中(ReturnStatement)</code> 然后 push 到 <code>代码块中(BlockStatement)</code>，</li> <li>其实我们要做就是把一棵树变成另外一颗树，说白了其实就是拼成另一颗树的结构，然后生成新的代码，就可以完成代码的转换</li></ol> <h3 id="访问者模式"><a href="#访问者模式" class="header-anchor">#</a> 访问者模式</h3> <p>在 babel 中，我们开发 plugins 的时候要用到访问者模式，就是说在访问到某一个路径的时候进行匹配，然后在对这个节点进行修改，比如说上面的当我们访问到 <code>ArrowFunctionExpression</code> 的时候，对 <code>ArrowFunctionExpression</code> 进行修改，变成普通函数</p> <p>那么我们就可以这么写：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">const fn = (a, b) =&gt; a + b</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// 转换后 const fn = function(a, b) { return a + b }</span>
<span class="token keyword">const</span> arrowFnPlugin <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 访问者模式</span>
  <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当访问到某个路径的时候进行匹配</span>
    <span class="token function">ArrowFunctionExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 拿到节点</span>
      <span class="token keyword">const</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ArrowFunctionExpression -&gt; node'</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> r <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>arrowFnPlugin<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="修改-ast-结构"><a href="#修改-ast-结构" class="header-anchor">#</a> 修改 AST 结构</h3> <p>此时我们拿到的结果是这样的节点结果是 <a href="https://chengyuming.cn/json/arrowFn.json" target="_blank" rel="noopener noreferrer">这样的<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，其实就是 <code>ArrowFunctionExpression</code> 的 AST，此时我们要做的是把 <code>ArrowFunctionExpression</code> 的结构替换成 <code>FunctionExpression</code>的结构，但是需要我们组装类似的结构，这么直接写很麻烦，但是 babel 为我们提供了一个工具叫做 <a href="https://babeljs.io/docs/en/babel-types" target="_blank" rel="noopener noreferrer"><code>@babel/types</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>@babel/types</code> 有两个作用：</p> <ol><li>判断这个节点是不是这个节点（ArrowFunctionExpression 下面的 path.node 是不是一个 ArrowFunctionExpression）</li> <li>生成对应的表达式</li></ol> <p>然后我们使用的时候，需要经常查文档，因为里面的节点类型特别多，不是做编译相关工作的是记不住怎么多节点的</p> <p>那么接下来我们就开始生成一个 <code>FunctionExpression</code>，然后把之前的 <code>ArrowFunctionExpression</code> 替换掉，我们可以看 <code>types</code> 文档，找到 <code>functionExpression</code>，该方法接受相应的参数我们传递过去即可生成一个 <code>FunctionExpression</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">functionExpression</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">,</span> generator<span class="token punctuation">,</span> async<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>id: Identifier (default: null) id 可传递 null</li> <li>params: Array&lt;LVal&gt; (required) 函数参数，可以把之前的参数拿过来</li> <li>body: BlockStatement (required) 函数体，接受一个 <code>BlockStatement</code> 我们需要生成一个</li> <li>generator: boolean (default: false) 是否为 generator 函数，当然不是了</li> <li>async: boolean (default: false) 是否为 async 函数，肯定不是了</li></ul> <p>还需要生成一个 <code>BlockStatement</code>，我们接着看文档找到 <code>BlockStatement</code> 接受的参数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> directives<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>看文档说明，<code>blockStatement</code> 接受一个 body，那我们把之前的 body 拿过来就可以直接用，不过这里 body 接受一个数组</p> <p>我们在看 AST 结构，函数表达式中的 <code>BlockStatement</code> 中的 <code>body</code> 是一个 <code>ReturnStatement</code> 组成的集合，所以还需要生成一个 <code>ReturnStatement</code></p> <p>现在我们就可以改写 AST 了</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">ArrowFunctionExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 拿到节点然后替换节点</span>
  <span class="token keyword">const</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
  <span class="token comment">// 拿到函数的参数</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> node<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
  <span class="token keyword">const</span> returnStatement <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">returnStatement</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> blockStatement <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span>returnStatement<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> functionExpression <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">functionExpression</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> blockStatement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 替换原来的函数</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>functionExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// 结果 const fn = function (a, b) { return a + b; };</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>当然如果没有返回语句的话我们也可以生成一个 <code>ExpressionStatement</code>，只需要把 <code>returnStatement</code> 改为 <code>ExpressionStatement</code> 其他逻辑不变</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token function">ArrowFunctionExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 拿到节点然后替换节点</span>
  <span class="token keyword">const</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
  <span class="token comment">// 拿到函数的参数</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> node<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
  <span class="token comment">// 把 returnStatement 换成 expressionStatement 即可</span>
  <span class="token keyword">const</span> expressionStatement <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> blockStatement <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span>expressionStatement<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> functionExpression <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">functionExpression</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> blockStatement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 替换原来的函数</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>functionExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// 结果 const fn = function (a, b) { a + b; };</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="按需引入"><a href="#按需引入" class="header-anchor">#</a> 按需引入</h2> <p>在开发中，我们引入 UI 框架，比如 vue 中用到的 <code>element-ui</code>，<code>vant</code> 或者 <code>React</code> 中的 <code>antd</code> 都支持全局引入和按需引入，默认是全局引入，如果需要按需引入就需要安装一个 <code>babel-plugin-import</code> 的插件，将全局的写法变成按需引入的写法。</p> <p>就拿我最近开发移动端用的 vant 为例， <code>import { Button } from 'vant'</code> 这种写法经过这个插件之后会变成 <code>import Button from 'vant/lib/Button'</code> 这种写法，引用整个 vant 变成了我只用了 vant 下面的某一个文件，打包后的文件会比全部引入的文件大小要小很多</p> <h3 id="分析语法树"><a href="#分析语法树" class="header-anchor">#</a> 分析语法树</h3> <blockquote><p><code>import { Button, Icon } from 'vant'</code> 写法转换为 <code>import Button from 'vant/lib/Button'; import Icon from 'vant/lib/Icon'</code></p></blockquote> <p>看一下两个语法树的区别</p> <p align="left" class="p-images"><img src="/docs/imgs/ast-import-plugins.jpg" width="" style="border-radius:8px;"></p> <p>根据两张图分析我们可以得到一些信息：</p> <ol><li>我们发现解构方式引入的模块只有 import 声明，第二张图是两个 import 声明</li> <li>解构方式引入的详细说明里面(<code>specifiers</code>)是两个 <code>ImportSpecifier</code>，第二张图里面是分开的，而且都是 <code>ImportDefaultSpecifier</code></li> <li>他们引入的 <code>source</code> 也不一样</li> <li>那我们要做的其实就是要把单个的 <code>ImportDeclaration</code> 变成多个 <code>ImportDeclaration</code>, 然后把单个 import 解构引入的 <code>specifiers</code> 部分 <code>ImportSpecifier</code> 转换成多个 <code>ImportDefaultSpecifier</code> 并修改对应的 <code>source</code> 即可</li></ol> <h3 id="分析类型"><a href="#分析类型" class="header-anchor">#</a> 分析类型</h3> <p>为了方便传递参数，这次我们写到一个函数里面，可以方便传递转换后拼接的目录</p> <p>这里我们需要用到的几个类型，也需要在 types 官网上找对应的解释</p> <ul><li><p>首先我们要生成多个 <code>importDeclaration</code> 类型</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * @param {Array&lt;ImportSpecifier | ImportDefaultSpecifier | ImportNamespaceSpecifier&gt;} specifiers  (required)
 * @param {StringLiteral} source (required)
 */</span>
t<span class="token punctuation">.</span><span class="token function">importDeclaration</span><span class="token punctuation">(</span>specifiers<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>在 <code>importDeclaration</code> 中需要生成 <code>ImportDefaultSpecifier</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * @param {Identifier} local  (required)
 */</span>
t<span class="token punctuation">.</span><span class="token function">importDefaultSpecifier</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>在 <code>importDeclaration</code> 中还需要生成一个 <code>StringLiteral</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * @param {string} value  (required)
 */</span>
t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ul> <h3 id="上代码"><a href="#上代码" class="header-anchor">#</a> 上代码</h3> <p>按照上面的分析，我们开始上代码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import { Button, Icon } from 'vant'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token comment">// import Button from 'vant/lib/Button'</span>
<span class="token comment">// import Icon from 'vant/lib/Icon'</span>
<span class="token keyword">function</span> <span class="token function">importPlugin</span><span class="token punctuation">(</span><span class="token parameter">opt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> libraryDir <span class="token punctuation">}</span> <span class="token operator">=</span> opt<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
        <span class="token comment">// console.log(&quot;ImportDeclaration -&gt; node&quot;, node)</span>
        <span class="token comment">// 得到节点的详细说明，然后转换成多个的 import 声明</span>
        <span class="token keyword">const</span> specifiers <span class="token operator">=</span> node<span class="token punctuation">.</span>specifiers<span class="token punctuation">;</span>
        <span class="token comment">// 要处理这个我们做一些判断，首先判断不是默认导出我们才处理，要考虑 import vant, { Button, Icon } from 'vant' 写法</span>
        <span class="token comment">// 还要考虑 specifiers 的长度，如果长度不是 1 并且不是默认导出我们才需要转换</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>specifiers<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span><span class="token function">isImportDefaultSpecifier</span><span class="token punctuation">(</span>specifiers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> result <span class="token operator">=</span> specifiers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">specifier</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> local <span class="token operator">=</span> specifier<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
            <span class="token keyword">const</span> source <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>libraryDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>specifier<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// console.log(&quot;ImportDeclaration -&gt; specifier&quot;, specifier)</span>
            <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">importDeclaration</span><span class="token punctuation">(</span><span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">importDefaultSpecifier</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ImportDeclaration -&gt; result'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 因为这次要替换的 AST 不是一个，而是多个的，所以需要 `path.replaceWithMultiple(result)` 来替换，但是一执行发现死循环了</span>
          path<span class="token punctuation">.</span><span class="token function">replaceWithMultiple</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> r <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">importPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">libraryDir</span><span class="token operator">:</span> <span class="token string">'lib'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>看打印结果和转换结果似乎没什么问题，这个插件几乎就实现了</p> <p align="left" class="p-images"><img src="/docs/imgs/ast-import-plugins-result_1.jpg" width="" style="border-radius:8px;"></p> <h3 id="特殊情况"><a href="#特殊情况" class="header-anchor">#</a> 特殊情况</h3> <p>但是我们考虑一种情况，如果用户不全部按需加载了，按需加载只是一种选择，如果用户这么写了 <code>import vant, { Button, Icon } from 'vant'</code>，那么我们这个插件就出现问题了</p> <p align="left" class="p-images"><img src="/docs/imgs/ast-import-plugins-result_2.jpg" width="" style="border-radius:8px;"></p> <p>如果遇到这种写法，那么默认导入的他的 <code>source</code> 应该是不变的，我们要把原来的 <code>source</code> 拿出来</p> <p>所以还需要判断一下，每一个 <code>specifier</code> 是不是一个 <code>ImportDefaultSpecifier</code> 然后处理不同的 <code>source</code>，完整处理逻辑应该如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">importPlugin</span><span class="token punctuation">(</span><span class="token parameter">opt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> libraryDir <span class="token punctuation">}</span> <span class="token operator">=</span> opt<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
        <span class="token comment">// console.log(&quot;ImportDeclaration -&gt; node&quot;, node)</span>
        <span class="token comment">// 得到节点的详细说明，然后转换成多个的 import 声明</span>
        <span class="token keyword">const</span> specifiers <span class="token operator">=</span> node<span class="token punctuation">.</span>specifiers<span class="token punctuation">;</span>
        <span class="token comment">// 要处理这个我们做一些判断，首先判断不是默认导出我们才处理，要考虑 import vant, { Button, Icon } from 'vant' 写法</span>
        <span class="token comment">// 还要考虑 specifiers 的长度，如果长度不是 1 并且不是默认导出我们才需要转换</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>specifiers<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span><span class="token function">isImportDefaultSpecifier</span><span class="token punctuation">(</span>specifiers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> result <span class="token operator">=</span> specifiers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">specifier</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> local <span class="token operator">=</span> specifier<span class="token punctuation">.</span>local<span class="token punctuation">,</span>
              source<span class="token punctuation">;</span>
            <span class="token comment">// 判断是否存在默认导出的情况</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isImportDefaultSpecifier</span><span class="token punctuation">(</span>specifier<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              source <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              source <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>
                <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>libraryDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>specifier<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">importDeclaration</span><span class="token punctuation">(</span><span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">importDefaultSpecifier</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          path<span class="token punctuation">.</span><span class="token function">replaceWithMultiple</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="babylon"><a href="#babylon" class="header-anchor">#</a> babylon</h2> <blockquote><p>在 babel 官网上有一句话 <a href="https://babeljs.io/docs/en/babylon" target="_blank" rel="noopener noreferrer">Babylon is a JavaScript parser used in Babel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></blockquote> <h3 id="babylon-与-babel-的关系"><a href="#babylon-与-babel-的关系" class="header-anchor">#</a> babylon 与 babel 的关系</h3> <p><code>babel</code> 使用的引擎是 <code>babylon</code>，<code>Babylon</code> 并非 <code>babel</code> 团队自己开发的，而是 fork 的 <code>acorn</code> 项目，<code>acorn</code> 的项目本人在很早之前在兴趣部落 1.0 在构建中使用，为了是做一些代码的转换，是很不错的一款引擎，不过 <code>acorn</code> 引擎只提供基本的解析 <code>ast</code> 的能力，遍历还需要配套的 <code>acorn-traversal</code>, 替换节点需要使用 acorn-，而这些开发，在 Babel 的插件体系开发下，变得一体化了（摘自 AlloyTeam 团队的<a href="http://www.alloyteam.com/2017/04/analysis-of-babel-babel-overview/" target="_blank" rel="noopener noreferrer">剖析 babel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <h3 id="使用-babylon"><a href="#使用-babylon" class="header-anchor">#</a> 使用 babylon</h3> <p>使用 babylon 编写一个数组 rest 转 Es5 语法的插件</p> <p>把 <code>const arr = [ ...arr1, ...arr2 ]</code> 转成 <code>var arr = [].concat(arr1, arr2)</code></p> <p>我们使用 babylon 的话就不需要使用 <code>@babel/core</code> 了，只需要用到他里面的 <code>traverse</code> 和 <code>generator</code>，用到的包有 <code>babylon、@babel/traverse、@babel/generator、@babel/types</code></p> <h3 id="分析语法树-2"><a href="#分析语法树-2" class="header-anchor">#</a> 分析语法树</h3> <p>先来看一下两棵语法树的区别</p> <p align="left" class="p-images"><img src="/docs/imgs/ast-rest-to-concat.jpg" width="" style="border-radius:8px;"></p> <p>根据上图我们分析得出：</p> <ol><li>两棵树都是变量声明的方式，不同的是他们声明的关键字不一样</li> <li>他们初始化变量值的时候是不一样的，一个数组表达式（ArrayExpression）另一个是调用表达式（CallExpression）</li> <li>那我们要做的就很简单了，就是把 数组表达式转换为调用表达式就可以</li></ol> <h3 id="分析类型-2"><a href="#分析类型-2" class="header-anchor">#</a> 分析类型</h3> <p>这段代码的核心生成一个 callExpression 调用表达式，所以对应官网上的类型，我们分析需要用到的 api</p> <ul><li><p>先来分析 init 里面的，首先是 callExpression</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * @param {Expression} callee  (required)
 * @param {Array&lt;Expression | SpreadElement | JSXNamespacedName&gt;} source (required)
 */</span>
t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>callee<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>对应语法树上 callee 是一个 MemberExpression，所以要生成一个成员表达式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * @param {Expression} object  (required)
 * @param {if computed then Expression else Identifier} property (required)
 * @param {boolean} computed (default: false)
 * @param {boolean} optional (default: null)
 */</span>
t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> property<span class="token punctuation">,</span> computed<span class="token punctuation">,</span> optional<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>在 callee 的 object 是一个 ArrayExpression 数组表达式，是一个空数组</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * @param {Array&lt;null | Expression | SpreadElement&gt;} elements  (default: [])
 */</span>
t<span class="token punctuation">.</span><span class="token function">arrayExpression</span><span class="token punctuation">(</span>elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>对了里面的东西分析完了，我们还要生成 VariableDeclarator 和 VariableDeclaration 最终生成新的语法树</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * @param {LVal} id  (required)
 * @param {Expression} init (default: null)
 */</span>
t<span class="token punctuation">.</span><span class="token function">variableDeclarator</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> init<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @param {&quot;var&quot; | &quot;let&quot; | &quot;const&quot;} kind  (required)
 * @param {Array&lt;VariableDeclarator&gt;} declarations (required)
 */</span>
t<span class="token punctuation">.</span><span class="token function">variableDeclaration</span><span class="token punctuation">(</span>kind<span class="token punctuation">,</span> declarations<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>其实倒着分析语法树，分析完怎么写也就清晰了，那么我们开始上代码吧</p></li></ul> <h3 id="上代码-2"><a href="#上代码-2" class="header-anchor">#</a> 上代码</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> babylon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babylon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用 babel 提供的包，traverse 和 generator 都是被暴露在 default 对象上的</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">const arr = [ ...arr1, ...arr2 ]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// var arr = [].concat(arr1, arr2)</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">'module'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 转换树</span>
<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">VariableDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
    <span class="token keyword">const</span> declarations <span class="token operator">=</span> node<span class="token punctuation">.</span>declarations<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'VariableDeclarator -&gt; declarations'</span><span class="token punctuation">,</span> declarations<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> kind <span class="token operator">=</span> <span class="token string">'var'</span><span class="token punctuation">;</span>
    <span class="token comment">// 边界判定</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      node<span class="token punctuation">.</span>kind <span class="token operator">!==</span> kind <span class="token operator">&amp;&amp;</span>
      declarations<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      t<span class="token punctuation">.</span><span class="token function">isArrayExpression</span><span class="token punctuation">(</span>declarations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>init<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 取得之前的 elements</span>
      <span class="token keyword">const</span> args <span class="token operator">=</span> declarations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>init<span class="token punctuation">.</span>elements<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>argument<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> callee <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">arrayExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'concat'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> init <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>callee<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> declaration <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">variableDeclarator</span><span class="token punctuation">(</span>declarations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> init<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> variableDeclaration <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">variableDeclaration</span><span class="token punctuation">(</span>kind<span class="token punctuation">,</span> <span class="token punctuation">[</span>declaration<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>variableDeclaration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h2 id="优雅处理-async-await"><a href="#优雅处理-async-await" class="header-anchor">#</a> 优雅处理 async await</h2> <p>异步终极解决方案：<code>async + await</code> 以同步的写法处理异步代码。一切都好，唯一有问题的就是要想捕获代码出现的问题需要使用 <code>try/catch</code> 包裹 await 代码片段。为了程序的健壮性，就可能需要在 async 中频繁的书写 <code>try/catch</code> 逻辑，此时我们可以就可以使用 ast 捕获到相应的代码然后处理没有被 <code>try/catch</code> 的 <code>await</code> 语句</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 转换前</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">asyncFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 转换后</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">asyncFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="分析语法树-3"><a href="#分析语法树-3" class="header-anchor">#</a> 分析语法树</h3> <p align="left" class="p-images"><img src="/docs/imgs/ast-async-try-catch.jpg" width="" style="border-radius:8px;"></p> <p>我们发现我们要做的就是在 <code>AwaitExpression</code> await 表达式外层包裹一层 <code>TryStatement</code> try 语句</p> <h3 id="分析类型-3"><a href="#分析类型-3" class="header-anchor">#</a> 分析类型</h3> <p>那我们要做的就是生成一个 tryStatement，查看对应的 api</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * @param {BlockStatement} block  (required)
 * @param {CatchClause} handler  (default: null)
 * @param {BlockStatement} finalizer (default: null)
 */</span>
t<span class="token punctuation">.</span><span class="token function">tryStatement</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> finalizer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>暂时先不考虑 CatchClause，先生成 try</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * @param {Array&lt;Statement&gt;} body  (required)
 * @param {Array&lt;Directive&gt;} directives  (default: [])
 */</span>
t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> directives<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>再根据 ast 树结构中得到，body 是由表达式语句（ExpressionStatement）组成</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * @param {Expression} expression  (required)
 */</span>
t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在 expressionStatement 中需要的 expression 就是我们的当前捕获到的节点，那么我们就可以开始写代码了</p> <h3 id="代码"><a href="#代码" class="header-anchor">#</a> 代码</h3> <p>我们要在 AwaitExpression 中捕获代码，还需要判断该代码段的父节点没有被 try/catch 包裹，可以利用 path 参数的 findParent 方法向上遍历所有父节点，判断是否被 try/catch 的 Node 包裹</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">AwaitExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 首先保证 await 语句没有被 try/catch 包裹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">findParent</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">isTryStatement</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> expression <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> tryBlock <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span>expression<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 生成 catch --&gt; console.log(e)</span>
  <span class="token keyword">const</span> paramsE <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> memberExpression <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">MemberExpression</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'console'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> consoleExpression <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>memberExpression<span class="token punctuation">,</span> <span class="token punctuation">[</span>paramsE<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> catchClause <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">catchClause</span><span class="token punctuation">(</span>paramsE<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span>consoleExpression<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> tryStatement <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">tryStatement</span><span class="token punctuation">(</span>tryBlock<span class="token punctuation">,</span> catchClause<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 数组</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWithMultiple</span><span class="token punctuation">(</span><span class="token punctuation">[</span>tryStatement<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 得到的结果：</span>
<span class="token comment">// async function func() {</span>
<span class="token comment">//   try {</span>
<span class="token comment">//     await asyncFn();</span>
<span class="token comment">//   } catch (e) {</span>
<span class="token comment">//     console.log(e);</span>
<span class="token comment">//   }</span>
<span class="token comment">// }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="其他情况"><a href="#其他情况" class="header-anchor">#</a> 其他情况</h3> <p>另外我们要考虑到 await 表达式可能出现其他情况，可以直接声明变量赋值，可以直接赋值，然后就是刚刚处理的直接一个表达式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 声明变量赋值</span>
<span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">asyncFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 赋值</span>
r <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">asyncFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 就是一个表达式</span>
<span class="token keyword">await</span> <span class="token function">asyncFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>此时我们可以区分不同的情况做不同的处理，再次观察语法树，发现他们的区别在 blockStatement 节点下面，那么我们就可以直接替换这一级就可以，顺便把 catch 语句补充完整</p> <p align="left" class="p-images"><img src="/docs/imgs/ast-async-try-catch-all.jpg" width="" style="border-radius:8px;"></p> <p>此时我们输入的代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">asyncFn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">asyncFn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">asyncFn3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>处理过程：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">AwaitExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 首先保证 await 语句没有被 try/catch 包裹</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">findParent</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">isTryStatement</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> parent <span class="token operator">=</span> path<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
  <span class="token keyword">let</span> replacePath <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isVariableDeclarator</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token operator">||</span> t<span class="token punctuation">.</span><span class="token function">isAssignmentExpression</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 赋值和声明的方式结构类似，都是在 AwaitExpression 中 path 的 parentPath.parentPath 上的节点就是 blockStatement 所需要的的参数，可以直接这么替换</span>
    replacePath <span class="token operator">=</span> path<span class="token punctuation">.</span>parentPath<span class="token punctuation">.</span>parentPath<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果只是表达式的话，path.parentPath.node 就是 blockStatement 参数</span>
    replacePath <span class="token operator">=</span> path<span class="token punctuation">.</span>parentPath<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> tryBlock <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span>replacePath<span class="token punctuation">.</span>node<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 生成 catch --&gt; new Error(e)</span>
  <span class="token keyword">const</span> paramsE <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'e'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> throwStatement <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">throwStatement</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">newExpression</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'Error'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>paramsE<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> catchClause <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">catchClause</span><span class="token punctuation">(</span>paramsE<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span>throwStatement<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> tryStatement <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">tryStatement</span><span class="token punctuation">(</span>tryBlock<span class="token punctuation">,</span> catchClause<span class="token punctuation">)</span><span class="token punctuation">;</span>
  replacePath<span class="token punctuation">.</span><span class="token function">replaceWithMultiple</span><span class="token punctuation">(</span><span class="token punctuation">[</span>tryStatement<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// 得到结果</span>
<span class="token comment">// async function func() {</span>
<span class="token comment">//   try {</span>
<span class="token comment">//     const r = await asyncFn1();</span>
<span class="token comment">//   } catch (e) {</span>
<span class="token comment">//     throw new Error(e);</span>
<span class="token comment">//   }</span>

<span class="token comment">//   try {</span>
<span class="token comment">//     res = await asyncFn2();</span>
<span class="token comment">//   } catch (e) {</span>
<span class="token comment">//     throw new Error(e);</span>
<span class="token comment">//   }</span>

<span class="token comment">//   try {</span>
<span class="token comment">//     await asyncFn3();</span>
<span class="token comment">//   } catch (e) {</span>
<span class="token comment">//     throw new Error(e);</span>
<span class="token comment">//   }</span>
<span class="token comment">// }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h2 id="具体语法书"><a href="#具体语法书" class="header-anchor">#</a> 具体语法书</h2> <p>和抽象语法树相对的是具体语法树（<code>Concrete Syntax Tree</code>）简称 <code>CST</code>（通常称作分析树）。一般的，在源代码的翻译和编译过程中，语法分析器创建出分析树。一旦 AST 被创建出来，在后续的处理过程中，比如语义分析阶段，会添加一些信息。可参考<a href="https://www.it-swarm.dev/zh/parsing/%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91%E5%92%8C%E5%85%B7%E4%BD%93%E8%AF%AD%E6%B3%95%E6%A0%91%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F/968637142/" target="_blank" rel="noopener noreferrer">抽象语法树和具体语法树有什么区别？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="补充"><a href="#补充" class="header-anchor">#</a> 补充</h2> <p>关于 node 类型，全集大致如下：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span> node: Identifier <span class="token operator">|</span> SimpleLiteral <span class="token operator">|</span> RegExpLiteral <span class="token operator">|</span> Program <span class="token operator">|</span> FunctionDeclaration <span class="token operator">|</span> FunctionExpression <span class="token operator">|</span> ArrowFunctionExpression <span class="token operator">|</span> SwitchCase <span class="token operator">|</span> CatchClause <span class="token operator">|</span> VariableDeclarator <span class="token operator">|</span> ExpressionStatement <span class="token operator">|</span> BlockStatement <span class="token operator">|</span> EmptyStatement <span class="token operator">|</span> DebuggerStatement <span class="token operator">|</span> WithStatement <span class="token operator">|</span> ReturnStatement <span class="token operator">|</span> LabeledStatement <span class="token operator">|</span> BreakStatement <span class="token operator">|</span> ContinueStatement <span class="token operator">|</span> IfStatement <span class="token operator">|</span> SwitchStatement <span class="token operator">|</span> ThrowStatement <span class="token operator">|</span> TryStatement <span class="token operator">|</span> WhileStatement <span class="token operator">|</span> DoWhileStatement <span class="token operator">|</span> ForStatement <span class="token operator">|</span> ForInStatement <span class="token operator">|</span> ForOfStatement <span class="token operator">|</span> VariableDeclaration <span class="token operator">|</span> ClassDeclaration <span class="token operator">|</span> ThisExpression <span class="token operator">|</span> ArrayExpression <span class="token operator">|</span> ObjectExpression <span class="token operator">|</span> YieldExpression <span class="token operator">|</span> UnaryExpression <span class="token operator">|</span> UpdateExpression <span class="token operator">|</span> BinaryExpression <span class="token operator">|</span> AssignmentExpression <span class="token operator">|</span> LogicalExpression <span class="token operator">|</span> MemberExpression <span class="token operator">|</span> ConditionalExpression <span class="token operator">|</span> SimpleCallExpression <span class="token operator">|</span> NewExpression <span class="token operator">|</span> SequenceExpression <span class="token operator">|</span> TemplateLiteral <span class="token operator">|</span> TaggedTemplateExpression <span class="token operator">|</span> ClassExpression <span class="token operator">|</span> MetaProperty <span class="token operator">|</span> AwaitExpression <span class="token operator">|</span> Property <span class="token operator">|</span> AssignmentProperty <span class="token operator">|</span> Super <span class="token operator">|</span> TemplateElement <span class="token operator">|</span> SpreadElement <span class="token operator">|</span> ObjectPattern <span class="token operator">|</span> ArrayPattern <span class="token operator">|</span> RestElement <span class="token operator">|</span> AssignmentPattern <span class="token operator">|</span> ClassBody <span class="token operator">|</span> MethodDefinition <span class="token operator">|</span> ImportDeclaration <span class="token operator">|</span> ExportNamedDeclaration <span class="token operator">|</span> ExportDefaultDeclaration <span class="token operator">|</span> ExportAllDeclaration <span class="token operator">|</span> ImportSpecifier <span class="token operator">|</span> ImportDefaultSpecifier <span class="token operator">|</span> ImportNamespaceSpecifier <span class="token operator">|</span> ExportSpecifier
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Babel 有文档对 AST 树的详细定义，可参考<a href="https://github.com/babel/babylon/blob/master/ast/spec.md" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="代码地址"><a href="#代码地址" class="header-anchor">#</a> 代码地址</h2> <p>代码以存放到 GitHub，<a href="https://github.com/fecym/ast-share.git" target="_blank" rel="noopener noreferrer">地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="相关链接"><a href="#相关链接" class="header-anchor">#</a> 相关链接</h2> <ol><li><a href="https://cheogo.github.io/learn-javascript/201709/runtime.html" target="_blank" rel="noopener noreferrer">JavaScript 语法解析、AST、V8、JIT<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/huangpb123/article/details/84799198" target="_blank" rel="noopener noreferrer">详解 AST 抽象语法树<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://segmentfault.com/a/1190000016706589?utm_medium=referral&amp;utm_source=tuicool" target="_blank" rel="noopener noreferrer">AST 抽象语法树<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ps: 这个里面有 class 转 Es5 构造函数的过程，有兴趣可以看一下</li> <li><a href="http://www.alloyteam.com/2017/04/analysis-of-babel-babel-overview" target="_blank" rel="noopener noreferrer">剖析 Babel——Babel 总览 | AlloyTeam<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.im/post/5d25b39bf265da1bb67a4176" target="_blank" rel="noopener noreferrer">不要给 async 函数写那么多 try/catch 了<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://babeljs.io/docs/en/babel-types" target="_blank" rel="noopener noreferrer">@babel/types<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.im/post/5eef4b416fb9a058583e7d71" target="_blank" rel="noopener noreferrer">文章已同步掘金<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">最后修改时间: </span> <span class="time">2022-08-07 15:44:14</span></div></footer> <!----> <!----></main> <!----> <div class="comments-wrapper" data-v-395662f4><div class="valine-wrapper"><div id="valine"></div></div></div></div></div></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/docs/assets/js/app.1f0be8d1.js" defer></script><script src="/docs/assets/js/3.8beeabb8.js" defer></script><script src="/docs/assets/js/1.226f09af.js" defer></script><script src="/docs/assets/js/47.ba0f0892.js" defer></script>
  </body>
</html>
